<!DOCTYPE html>
<html lang="en">
	<head>
		{{> main}}
		<title>New Customer and Booking</title>
		<pre>{{{json retreats}}}</pre>

		<script id="retreats-data" type="application/json">
			{{{json retreats}}}
		</script>
		<script>
			document.addEventListener('DOMContentLoaded', () => {
				console.log("DOM fully loaded and parsed");
				const retreats = JSON.parse(document.getElementById('retreats-data').textContent);

				console.log("Retreats loaded into script: ", retreats)


				const retreatSelect = document.getElementById('retreat_id');
				const startDateField = document.getElementById('start_date');
				const mealSelect = document.getElementById('meal_choices');

				function updateRetreatDetails() {
					const selectedId = retreatSelect.value;
					const retreat = retreats.find(r => r.retreat_id == selectedId);

					if (retreat) {
						// Update start date
						const dateObj = new Date(retreat.start_date);
						dateObj.setMinutes(dateObj.getMinutes() - dateObj.getTimezoneOffset()); // Adjust for local time zone
						const formattedDate = dateObj.toISOString().split('T')[0];
  						startDateField.value = formattedDate;

						// Update meal options
						mealSelect.innerHTML = '';
						retreat.meal_options.forEach(option => {
							const opt = document.createElement('option');
							opt.value = option;
							opt.textContent = option;
							mealSelect.appendChild(opt);
						});
					}

				}

				retreatSelect.addEventListener('change', updateRetreatDetails);
				updateRetreatDetails(); // Trigger on load
			});
		</script>
	</head>
	<body>
		
		<div class="new-customer-container">
			<div class="new-customer-title">Add a new customer and booking:</div>

			<form class="new-customer-form" id="new-customer-form" action="/new-reservation" method="POST">
				<!-- Customer Info -->
				<div class="new-customer-label">Name</div>
				<input type="text" id="name" name="name" required>

				<div class="new-customer-label">Email</div>
				<input type="email" id="email" name="email" required>

				<div class="new-customer-label">Phone Number</div>
				<input type="text" id="phone" name="phone" required>

				<!-- Booking Info -->
				<hr>

				<div class="new-customer-label">Select Retreat</div>
				<select name="retreat_id" id="retreat_id" required>
					{{#each retreats}}
						<option value="{{this.retreat_id}}">
							{{this.retreat_name}} - {{formatDate this.start_date}}
						</option>
					{{/each}}
				</select>

				<div class="new-customer-label">Retreat Start Date</div>
				<input type="date" id="start_date" name="start_date" readonly required>

				<div class="new-customer-label">Number of Guests</div>
				<input type="number" id="guests" name="guests" min="1" required>

				<div class="new-customer-label">Meal Preferences</div>
				<select id="meal_choices" name="meal_choices[]" multiple required></select>

				<input type="submit" value="Submit">
			</form>
			{{!-- <div class="new-customer-title">Add a new customer:</div>
			<form class="new-customer-form" id="new-customer-form" action="/customers" method="POST">
				<div class="new-customer-label">Name</div>
				<input type="text" id="name" name="name">

				<div class="new-customer-label">Email</div>
				<input type="text" id="email" name="email">
				<div class="new-customer-label">Phone Number</div>
				<input type="text" id="phone" name="phone">
				<input type="submit" value="Submit">
			</form> --}}
			<div id="new-customer-confirmation"> Customer added to database.</div>
		</div>
		{{> footer}}
	</body>
</html>