<!DOCTYPE html>
<html lang="en">
	<head>
		{{> main}}
		<title>New Customer and Booking</title>
		<pre>{{{json retreats}}}</pre>

		<script id="retreats-data" type="application/json">
			{{{json retreats}}}
		</script>
		<script>
			document.addEventListener('DOMContentLoaded', () => {
    const retreats = JSON.parse(document.getElementById('retreats-data').textContent);

    const retreatSelect = document.getElementById('retreat_id');
    const startDateField = document.getElementById('start_date');
    const numGuestsInput = document.getElementById('num_guests');
    const mealChoicesContainer = document.getElementById('meal-choices-container');

    function updateRetreatDetails() {
        const selectedId = retreatSelect.value;
        const retreat = retreats.find(r => r.retreat_id == selectedId);

        if (retreat) {
            // Update start date
            const dateObj = new Date(retreat.start_date);
            dateObj.setMinutes(dateObj.getMinutes() - dateObj.getTimezoneOffset()); // Adjust for local time zone
            const formattedDate = dateObj.toISOString().split('T')[0];
            startDateField.value = formattedDate;

            // Update meal options dynamically based on the number of guests
            numGuestsInput.addEventListener('input', () => {
                const numGuests = parseInt(numGuestsInput.value, 10);

                // Clear existing meal choice dropdowns
                mealChoicesContainer.innerHTML = '';

                if (isNaN(numGuests) || numGuests <= 0) {
                    mealChoicesContainer.innerHTML = '<p>Please enter a valid number of guests.</p>';
                    return;
                }

                // Create a dropdown for each guest
                for (let i = 0; i < numGuests; i++) {
                    const label = document.createElement('label');
                    label.textContent = `Guest ${i + 1} Meal Preference:`;

                    const select = document.createElement('select');
                    select.name = `meal_choices[${i}]`;
                    select.required = true;

					// after the label and the select element, start a new line
					label.style.display = 'block';

                    // Populate the dropdown with meal options
                    retreat.meal_options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option;
                        opt.textContent = option;
                        select.appendChild(opt);
                    });

                    // Append the label and dropdown to the container
                    mealChoicesContainer.appendChild(label);
                    mealChoicesContainer.appendChild(select);
                }
            });
        }
    }

    retreatSelect.addEventListener('change', updateRetreatDetails);
    updateRetreatDetails(); // Trigger on load
});
		</script>
	</head>
	<body>
		
		<div class="new-customer-container">
			<div class="new-customer-title">Add a new customer and booking:</div>

			<form class="new-customer-form" id="new-customer-form" action="/new-reservation" method="POST">
				<!-- Customer Info -->
				<div class="new-customer-label">Name</div>
				<input type="text" id="name" name="name" required>

				<div class="new-customer-label">Email</div>
				<input type="email" id="email" name="email" required>

				<div class="new-customer-label">Phone Number</div>
				<input type="text" id="phone" name="phone" required>

				<!-- Booking Info -->
				<hr>

				<div class="new-customer-label">Select Retreat</div>
				<select name="retreat_id" id="retreat_id" required>
					{{#each retreats}}
						<option value="{{this.retreat_id}}">
							{{this.retreat_name}} - {{formatDate this.start_date}}
						</option>
					{{/each}}
				</select>

				<div class="new-customer-label">Retreat Start Date</div>
				<input type="date" id="start_date" name="start_date" readonly required>

				<div class="new-customer-label">Number of Guests</div>
				<input type="number" id="num_guests" name="num_guests" min="1" required>

				<div class="new-customer-label">Meal Preferences</div>
				<div id="meal-choices-container"></div>

				<input type="submit" value="Submit">
			</form>
			<div id="new-customer-confirmation"> Customer added to database.</div>
		</div>
		{{> footer}}
	</body>
</html>